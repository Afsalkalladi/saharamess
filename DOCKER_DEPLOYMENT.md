# üê≥ Docker Deployment Guide

## üöÄ Quick Start with Docker

### **Option 1: Development Environment**
```bash
# Clone the repository
git clone https://github.com/Afsalkalladi/saharamess.git
cd saharamess

# Create environment file
cp .env.example .env.development
# Edit .env.development with your values

# Start all services
docker-compose up -d

# View logs
docker-compose logs -f
```

### **Option 2: Production Environment**
```bash
# Create production environment file
cp .env.example .env.production
# Edit .env.production with production values

# Start production services
docker-compose -f docker-compose.prod.yml up -d

# View logs
docker-compose -f docker-compose.prod.yml logs -f
```

## üîß Environment Variables

Create `.env.production` file:
```bash
# Database
DB_NAME=mess_management
DB_USER=postgres
DB_PASSWORD=your_secure_password

# Django
SECRET_KEY=your-super-secret-key-here-change-in-production
DEBUG=False

# Telegram Bot
TELEGRAM_BOT_TOKEN=your_telegram_bot_token
ADMIN_TG_IDS=123456789,987654321

# Security
QR_SECRET=your-32-character-secret-key-here
STAFF_SCANNER_PASSWORD=your_admin_password

# External Services (Optional)
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
SHEETS_CREDENTIALS_JSON={"type": "service_account", ...}
SHEETS_SPREADSHEET_ID=your_spreadsheet_id
```

## üì¶ Services Overview

| Service | Port | Description |
|---------|------|-------------|
| **nginx** | 80, 443 | Reverse proxy & static files |
| **web** | 8000 | Django application |
| **db** | 5432 | PostgreSQL database |
| **redis** | 6379 | Cache & message broker |
| **worker** | - | Celery background tasks |
| **telegram-bot** | - | Telegram bot service |

## üõ†Ô∏è Management Commands

```bash
# Create superuser
docker-compose exec web python manage.py createsuperuser

# Run migrations
docker-compose exec web python manage.py migrate

# Generate QR codes
docker-compose exec web python manage.py generate_qr_codes

# Backup data
docker-compose exec web python manage.py backup_data

# View logs
docker-compose logs -f web
docker-compose logs -f telegram-bot
docker-compose logs -f worker
```

## üîç Health Checks

Check service status:
```bash
# All services
docker-compose ps

# Web application health
curl http://localhost/health/

# Database connection
docker-compose exec db pg_isready -U postgres

# Redis connection
docker-compose exec redis redis-cli ping
```

## üöÄ Deploy to Render with Docker

1. **Create Render Account**: Go to [render.com](https://render.com)

2. **Create Web Service**:
   - Choose "Docker" as environment
   - Connect your GitHub repository
   - Set build command: `docker build -t mess-app .`
   - Set start command: `docker run -p 8000:8000 mess-app`

3. **Add Environment Variables** in Render dashboard:
   ```
   DJANGO_SETTINGS_MODULE=mess_management.settings.production
   DATABASE_URL=postgresql://... (auto-generated by Render)
   REDIS_URL=redis://... (auto-generated by Render)
   TELEGRAM_BOT_TOKEN=your_bot_token
   ADMIN_TG_IDS=your_telegram_id
   QR_SECRET=your_32_char_secret
   SECRET_KEY=your_django_secret
   ```

4. **Add PostgreSQL Database**:
   - Create PostgreSQL service in Render
   - Copy connection string to `DATABASE_URL`

5. **Add Redis Instance**:
   - Create Redis service in Render
   - Copy connection string to `REDIS_URL`

## üîß Troubleshooting

### Common Issues:

**1. Database Connection Error**
```bash
# Check database status
docker-compose exec db pg_isready -U postgres

# View database logs
docker-compose logs db
```

**2. Telegram Bot Not Working**
```bash
# Check bot logs
docker-compose logs telegram-bot

# Verify bot token
docker-compose exec web python -c "
from django.conf import settings
print('Bot token:', settings.TELEGRAM_BOT_TOKEN[:10] + '...')
"
```

**3. Static Files Not Loading**
```bash
# Collect static files
docker-compose exec web python manage.py collectstatic --noinput

# Check nginx logs
docker-compose logs nginx
```

**4. Celery Worker Issues**
```bash
# Check worker status
docker-compose exec worker celery -A mess_management inspect ping

# View worker logs
docker-compose logs worker
```

## üìä Monitoring

### View Real-time Logs:
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f web
docker-compose logs -f telegram-bot
```

### Resource Usage:
```bash
# Container stats
docker stats

# Service resource usage
docker-compose top
```

## üîí Security Notes

- Change all default passwords in production
- Use strong SECRET_KEY (32+ characters)
- Enable HTTPS in production
- Regularly update Docker images
- Monitor logs for suspicious activity
- Backup database regularly

## üéØ Production Checklist

- [ ] Set `DEBUG=False` in production
- [ ] Configure proper `ALLOWED_HOSTS`
- [ ] Use strong passwords and secrets
- [ ] Enable SSL/HTTPS
- [ ] Set up log rotation
- [ ] Configure monitoring
- [ ] Set up automated backups
- [ ] Test disaster recovery
